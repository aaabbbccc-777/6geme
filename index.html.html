<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•°å­—æ¨ç†ã‚²ãƒ¼ãƒ  </title>
<style>
body { font-family: sans-serif; background:#f5f5f5; text-align:center; padding:10px; }
.row { display:flex; justify-content:center; gap:8px; margin:10px 0; }
.num { width:45px; height:45px; line-height:45px; border:2px solid #333; border-radius:8px; font-size:18px; background:white; }
.hidden { background:#999; color:white; }
.revealed { background:#2196f3; color:white; }
.selected { background:#ff9800; color:white; }
.clickable { cursor:pointer; }
button { margin:5px; padding:8px 14px; font-size:14px; }
.numBtn { width:36px; height:36px; margin:4px; border-radius:50%; border:2px solid #333; background:white; }
.numBtn.selected { background:#3ba93f; color:white; }
#guessArea { display:none; }
#guessLog { max-width:360px; margin:10px auto; background:white; padding:10px; text-align:left; font-size:14px; }
.overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; }
.box { background:white; padding:30px; border-radius:12px; }
#effectInfo { margin:10px; font-weight:bold; }
</style>
</head>
<body>

<h2>è‡ªåˆ†ã®æ•°å­—</h2>
<div class="row" id="myRow"></div>

<h2>ç›¸æ‰‹ã®é…ç½®</h2>
<div class="row" id="enemyRow"></div>

<div id="effectInfo">é¸æŠä¸­ã®æ•°å­—ã®åŠ¹æœ: ãªã—</div>

<button id="revealBtn">é¸ã‚“ã æ•°å­—ã‚’é–‹ç¤º</button>
<button id="skipBtn">ã“ã®ã‚¿ãƒ¼ãƒ³ã¯é–‹ç¤ºã—ãªã„</button>

<div id="guessArea">
<h3>æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚º</h3>
<div id="numberButtons"></div>
<p id="guessInfo">ç›¸æ‰‹ã®ï¼Ÿã‚’ã‚¿ãƒƒãƒ—</p>
<button id="guessBtn">æŒ‡æ‘˜ã™ã‚‹</button>
</div>

<div id="replaceButtons" style="display:none;"></div>

<div id="repeatArea" style="display:none"></div>
<button id="repeatConfirmBtn" style="display:none">å†ç™ºå‹•</button>

<h3>æŒ‡æ‘˜ãƒ­ã‚°</h3>
<div id="guessLog"></div>

<div id="winScreen" class="overlay">
<div class="box">
<h1>ğŸ‰ YOU WIN ğŸ‰</h1>
<button onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
</div>
</div>

<div id="loseScreen" class="overlay">
<div class="box">
<h1>ğŸ’€ YOU LOSE ğŸ’€</h1>
<button onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
</div>
</div>

<script>
/* ---------- åˆæœŸåŒ– ---------- */
const shuffle = a => a.sort(()=>Math.random()-0.5);
let myNums = shuffle([1,2,3,4,5,6,7,8,9]).slice(0,6);
let enemyNums = shuffle([1,2,3,4,5,6,7,8,9]).slice(0,6);
let myRevealed = Array(6).fill(false);
let enemyRevealed = Array(6).fill(false);

let aiTried = Array.from({length:6},()=>[]);
let aiKnownNumbers = [];
let playerKnownEnemyNumbers = [];
let playerExcludedEnemyNumbers = [];
let aiExcludedNumbers = [];
let aiAlreadyRevealed = [];

let selectedMy=null;
let effectQueue = [];
let selectedEnemyPos=null;
let selectedGuessNum=null;

let openedThisTurn=false;
let activeEffect=null;
let turn=1;
const guessLog=[];

let negateEnemyEffectThisTurn = false;
let negatePlayerEffectThisTurn = false;

let skipEnemyGuessThisTurn = false;
let skipPlayerGuessThisTurn = false;

let aiRevealedThisTurn = false;

let swapPhase = false; 
let swapTargets = []; 

let playerGuessRemaining = 1;
let aiGuessRemaining = 1;

let aiGuessedPositionsThisTurn = [];
let aiGuessCountThisTurn = 0;

let replacePhase = false;
let replaceFromIndex = null;
let replaceToNumber = null;
let replaceCandidates = []; 

let playerRevealedEffects = [];
let aiRevealedEffects = [];
let repeatPhase = false;
let repeatCandidates = [];
let selectedRepeatEffect = null;

let effect9Active = false;
let aiEffect9Active = false;

let aiAlreadyUsedEffect1 = false;

const effectMap={
1: "ç›¸æ‰‹ãŒé–‹ç¤ºã—ãŸæ•°å­—ã®åŠ¹æœã‚’ç„¡åŠ¹åŒ–",
2: "ç›¸æ‰‹ã®æ•°å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ç¢ºèª",
3: "ç›¸æ‰‹ã«ãªã„æ•°å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«2ã¤ç¢ºèª",
4: "ç›¸æ‰‹ã®æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã‚¹ã‚­ãƒƒãƒ—",
5: "è‡ªåˆ†ã®æœªå…¬é–‹æ•°å­—2ã¤ã®ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆã‚‹",
6: "ã“ã®ã‚¿ãƒ¼ãƒ³ã€æŒ‡æ‘˜ã‚’2å›è¡Œãˆã‚‹",
7: "è‡ªåˆ†ã®æœªå…¬é–‹æ•°å­—ã‚’å ´ã«ãªã„æ•°å­—ã¨äº¤æ›ã§ãã‚‹",
8: "é–‹ç¤ºæ¸ˆæ•°å­—ã®åŠ¹æœã‚’ã‚‚ã†ä¸€åº¦ç™ºå‹•ã§ãã‚‹",
9: "ã™ã¹ã¦ã®æœªå…¬é–‹æ•°å­—ã‚’æŒ‡æ‘˜å¯èƒ½ï¼ˆé–“é•ã†ã¨æ•—åŒ—ï¼‰"
};

function resolveEffects(){
effectQueue.sort((a,b)=>{
if(a.num !== b.num) return a.num - b.num;
return a.owner === "player" ? -1 : 1;
});

for(const e of effectQueue){
// ç„¡åŠ¹åŒ–åˆ¤å®š
if(e.owner === "player" && negatePlayerEffectThisTurn){
guessLog.push(`ã‚ãªãŸã®åŠ¹æœ${e.num}ã¯ç„¡åŠ¹åŒ–ã•ã‚ŒãŸ`);
continue;
}
if(e.owner === "ai" && negateEnemyEffectThisTurn){
guessLog.push(`AIã®åŠ¹æœ${e.num}ã¯ç„¡åŠ¹åŒ–ã•ã‚ŒãŸ`);
continue;
}

// åŠ¹æœ1ã¯ã€Œãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã ã‘ã€
if(e.num === 1){
if(e.owner === "player"){
negateEnemyEffectThisTurn = true;
guessLog.push("åŠ¹æœ1ç™ºå‹•ï¼šAIã®é–‹ç¤ºåŠ¹æœã‚’ç„¡åŠ¹åŒ–");
}else{
negatePlayerEffectThisTurn = true;
guessLog.push("AIã®åŠ¹æœ1ï¼šã‚ãªãŸã®é–‹ç¤ºåŠ¹æœã‚’ç„¡åŠ¹åŒ–");
}
continue;
}

// åŠ¹æœ4
if(e.num === 4){
if(e.owner === "player") skipEnemyGuessThisTurn = true;
else skipPlayerGuessThisTurn = true;
guessLog.push("åŠ¹æœ4ç™ºå‹•ï¼šæŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã‚¹ã‚­ãƒƒãƒ—");
continue;
}

applyEffect(e.owner, e.num);
}

effectQueue = [];
drawLog(); drawMy(); drawEnemy();
}

function applyEffect(owner, num){
switch(num){
case 2:
if(owner === "player"){
// ç›¸æ‰‹ã®æœªå…¬é–‹æ•°å­—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤çŸ¥ã‚‹
const candidates = enemyNums.filter(n =>
!playerKnownEnemyNumbers.includes(n)
);

if(candidates.length){
const known = candidates[Math.floor(Math.random()*candidates.length)];
playerKnownEnemyNumbers.push(known);
guessLog.push(`åŠ¹æœ2ï¼šç›¸æ‰‹ã®æ•°å­—ã«ã€Œ${known}ã€ãŒã‚ã‚‹ã¨åˆ¤æ˜`);
} else {
guessLog.push("åŠ¹æœ2ï¼šæ–°ã—ãçŸ¥ã‚Œã‚‹æ•°å­—ãŒãªã‹ã£ãŸ");
}
} else {
// AIå´
const candidates = myNums.filter(n =>
!aiKnownNumbers.includes(n)
);

if(candidates.length){
const known = candidates[Math.floor(Math.random()*candidates.length)];
aiKnownNumbers.push(known);
guessLog.push(`AIã®åŠ¹æœ2ï¼šã‚ãªãŸã®æ•°å­—ã«ã€Œ${known}ã€ãŒã‚ã‚‹ã¨æŠŠæ¡ã—ãŸ`);
} else {
guessLog.push("AIã®åŠ¹æœ2ï¼šæ–°æƒ…å ±ãªã—");
}
}
break;
case 3:
if(owner === "player"){
const allNums = [1,2,3,4,5,6,7,8,9];
const notInEnemy = allNums.filter(n =>
!enemyNums.includes(n) &&
!playerExcludedEnemyNumbers.includes(n)
);

shuffle(notInEnemy);

const gained = notInEnemy.slice(0,2);
gained.forEach(n => playerExcludedEnemyNumbers.push(n));

if(gained.length){
guessLog.push(`åŠ¹æœ3ï¼šç›¸æ‰‹ã«ãªã„æ•°å­—ã€Œ${gained.join("ãƒ»")}ã€ãŒåˆ¤æ˜`);
} else {
guessLog.push("åŠ¹æœ3ï¼šæ–°ã—ãåˆ¤æ˜ã—ãŸæ•°å­—ã¯ãªã‹ã£ãŸ");
}
} else {
// AIå´
const allNums = [1,2,3,4,5,6,7,8,9];
const notInPlayer = allNums.filter(n =>
!myNums.includes(n) &&
!aiExcludedNumbers.includes(n)
);

shuffle(notInPlayer);

const gained = notInPlayer.slice(0,2);
gained.forEach(n => aiExcludedNumbers.push(n));

if(gained.length){
guessLog.push(`AIã®åŠ¹æœ3ï¼šã‚ãªãŸã«ãªã„æ•°å­—ã€Œ${gained.join("ãƒ»")}ã€ã‚’æŠŠæ¡ã—ãŸ`);
} else {
guessLog.push("AIã®åŠ¹æœ3ï¼šæ–°æƒ…å ±ãªã—");
}
}
break;
case 5:
if(owner === "player"){
const unrevealed = [];
for(let i=0;i<6;i++){
if(!myRevealed[i]) unrevealed.push(i);
}
swapPhase = true;
swapTargets = [];
guessLog.push("åŠ¹æœ5ï¼šå…¥ã‚Œæ›¿ãˆã‚‹2ã¤ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„");
} else {
const unrevealed = [];
for(let i=0;i<6;i++) if(!enemyRevealed[i]) unrevealed.push(i);
if(unrevealed.length >= 3){
const [a,b] = shuffle(unrevealed).slice(0,2);
[enemyNums[a], enemyNums[b]] = [enemyNums[b], enemyNums[a]];
guessLog.push("AIã®åŠ¹æœ5ï¼šæœªå…¬é–‹ã®2ã¤ã®ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆãŸ");
}
}
break;
case 6:
if(owner === "player"){
playerGuessRemaining = 2;
guessLog.push("åŠ¹æœ6ç™ºå‹•ï¼šã“ã®ã‚¿ãƒ¼ãƒ³æŒ‡æ‘˜ã‚’2å›è¡Œãˆã‚‹");
} else {
aiGuessRemaining = 2;
guessLog.push("AIã®åŠ¹æœ6ç™ºå‹•ï¼šã“ã®ã‚¿ãƒ¼ãƒ³æŒ‡æ‘˜ã‚’2å›è¡Œã†");
}
break;
case 7:
if(owner === "player"){
replaceCandidates = [];
for(let i=1;i<=9;i++){
if(!myNums.includes(i)){
replaceCandidates.push(i);
}
}
if(replaceCandidates.length === 0){
guessLog.push("åŠ¹æœ7ï¼šäº¤æ›ã§ãã‚‹æ•°å­—ãŒãªã‹ã£ãŸ");
break;
}
replacePhase = true;
replaceFromIndex = null;
replaceToNumber = null;

guessLog.push(
`åŠ¹æœ7ç™ºå‹•ï¼šæœªå…¬é–‹æ•°å­—ã‚’1ã¤é¸ã³ã€æ¬¡ã«äº¤æ›ã™ã‚‹æ•°å­—ã‚’é¸æŠ`
);
document.getElementById("guessArea").style.display = "none";
document.getElementById("revealBtn").style.display = "none";
document.getElementById("skipBtn").style.display = "none";
drawReplaceButtons();
} else {
// ===== AIç”¨ åŠ¹æœ7 =====

// AIã®æœªå…¬é–‹ä½ç½®
const unrevealed = [];
for(let i=0;i<6;i++){
if(!enemyRevealed[i]) unrevealed.push(i);
}

if(unrevealed.length === 0){
guessLog.push("AIã®åŠ¹æœ7ï¼šäº¤æ›ã§ãã‚‹æœªå…¬é–‹æ•°å­—ãŒãªã‹ã£ãŸ");
break;
}

// AIãŒæŒã£ã¦ã„ãªã„æ•°å­—
const notInAI = [];
for(let i=1;i<=9;i++){
if(!enemyNums.includes(i)){
notInAI.push(i);
}
}

if(notInAI.length === 0){
guessLog.push("AIã®åŠ¹æœ7ï¼šäº¤æ›å¯èƒ½ãªæ•°å­—ãŒãªã‹ã£ãŸ");
break;
}

const fromIndex =
unrevealed[Math.floor(Math.random() * unrevealed.length)];
const toNumber =
notInAI[Math.floor(Math.random() * notInAI.length)];

const oldNum = enemyNums[fromIndex];
enemyNums[fromIndex] = toNumber;

guessLog.push(
`AIã®åŠ¹æœ7ï¼šæœªå…¬é–‹æ•°å­—ã‚’å ´ã«ãªã„æ•°å­—ã¨äº¤æ›ã—ãŸ`
);
}
break;
case 8:
if(owner === "player"){
// å†ç™ºå‹•ãƒ•ã‚§ãƒ¼ã‚ºä¸­ã¯ç„¡è¦–ã—ã¦ç¶šè¡Œ
if(!repeatPhase) {
const candidates = playerRevealedEffects.filter(n => n !== 8);
if(candidates.length){
repeatPhase = true;
repeatCandidates = candidates;
selectedRepeatEffect = null;

document.getElementById("repeatArea").style.display = "block";
document.getElementById("repeatConfirmBtn").style.display = "inline-block";
drawRepeatButtons();
guessLog.push("åŠ¹æœ8ï¼šå†ç™ºå‹•ã™ã‚‹åŠ¹æœã‚’é¸æŠã—ã¦ãã ã•ã„");
}
}
} else {
// AIã¯ãƒ©ãƒ³ãƒ€ãƒ å†ç™ºå‹•
const candidates = aiRevealedEffects.filter(n => n !== 8);
if(candidates.length){
const chosen = candidates[Math.floor(Math.random()*candidates.length)];
guessLog.push(`AIã®åŠ¹æœ8ï¼šåŠ¹æœ${chosen}ã‚’å†ç™ºå‹•`);
effectQueue.push({ owner:"ai", num:chosen });
}
}
break;
case 9:
if(owner === "player"){
const unrevealedCount = myRevealed.filter(v=>!v).length;
playerGuessRemaining = unrevealedCount; // æœªå…¬é–‹å…¨ã¦æŒ‡æ‘˜å¯èƒ½
effect9Active = true; // ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
guessLog.push(`åŠ¹æœ9ç™ºå‹•ï¼šæœªå…¬é–‹æ•°å­—ã™ã¹ã¦ã‚’æŒ‡æ‘˜å¯èƒ½ï¼ˆé–“é•ã†ã¨æ•—åŒ—ï¼‰`);
} else {
const unrevealedCount = enemyRevealed.filter(v=>!v).length;
aiGuessRemaining = unrevealedCount;
aiEffect9Active = true; // AIç”¨ãƒ•ãƒ©ã‚°
guessLog.push(`AIã®åŠ¹æœ9ç™ºå‹•ï¼šæœªå…¬é–‹æ•°å­—ã™ã¹ã¦ã‚’æŒ‡æ‘˜å¯èƒ½ï¼ˆé–“é•ã†ã¨æ•—åŒ—ï¼‰`);
}
break;
}
drawLog();
drawMy();
drawEnemy();
}

/* ---------- æç”» ---------- */
function drawReplaceButtons(){
const area = document.getElementById("replaceButtons");
area.innerHTML = "";
area.style.display = "block";
replaceCandidates.forEach(n=>{
const b = document.createElement("button");
b.className = "numBtn";
b.textContent = n;
if(replaceToNumber === n) b.classList.add("selected");
b.onclick = ()=>{
replaceToNumber = n;
drawReplaceButtons();
tryExecuteReplace();
};
area.appendChild(b);
});
}
function tryExecuteReplace(){
if(replaceFromIndex === null) return;
if(replaceToNumber === null) return;

const oldNum = myNums[replaceFromIndex];
myNums[replaceFromIndex] = replaceToNumber;

guessLog.push(
`åŠ¹æœ7ç™ºå‹•ï¼šä½ç½®${replaceFromIndex + 1}ã® ${oldNum} ã‚’ ${replaceToNumber} ã«äº¤æ›ã—ãŸ`
);

// ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†
replacePhase = false;
replaceFromIndex = null;
replaceToNumber = null;
replaceCandidates = [];

document.getElementById("replaceButtons").style.display = "none";

drawMy();
drawLog();
startGuess();
}



function drawMy(){
const row=document.getElementById("myRow");
row.innerHTML="";
const unrevealedIndices=[];
myRevealed.forEach((v,i)=>{ if(!v) unrevealedIndices.push(i); });
myNums.forEach((n,i)=>{
const d=document.createElement("div");
d.className="num clickable";
d.textContent=n;
if(myRevealed[i]) d.classList.add("revealed");
if(selectedMy===i) d.classList.add("selected");
if(replacePhase && replaceFromIndex === i){
d.classList.add("selected");}
d.onclick = () => {
if (repeatPhase) return;
if (myRevealed[i]) return;
// --- 7ï¼šäº¤æ›ãƒ•ã‚§ãƒ¼ã‚º ---
if(replacePhase){
replaceFromIndex = i;
drawMy();
tryExecuteReplace();
return;
}

// --- 5ï¼šå…¥ã‚Œæ›¿ãˆãƒ•ã‚§ãƒ¼ã‚º ---
if(swapPhase){
if(swapTargets.includes(i)) return;
swapTargets.push(i);
d.classList.add("selected");

if(swapTargets.length === 2){
const [a,b] = swapTargets;
[myNums[a], myNums[b]] = [myNums[b], myNums[a]];
guessLog.push(`åŠ¹æœ5ç™ºå‹•ï¼šä½ç½®${a+1}ã¨${b+1}ã‚’å…¥ã‚Œæ›¿ãˆãŸ`);
swapPhase = false;
swapTargets = [];
replacePhase = false;
drawMy();
drawLog();
startGuess();
}
return;
}

// é€šå¸¸æ™‚ã®é¸æŠ
if (openedThisTurn) return;
if(unrevealedIndices.length===1) return; // æ®‹ã‚Š1ã¤ã®æ•°å­—ã¯é¸ã¹ãªã„
if(selectedMy===i){
selectedMy=null;
document.getElementById("effectInfo").textContent="é¸æŠä¸­ã®æ•°å­—ã®åŠ¹æœ: ãªã—";
}else{
selectedMy=i;
document.getElementById("effectInfo").textContent=
`é¸æŠä¸­ã®æ•°å­—ã®åŠ¹æœ: ${effectMap[myNums[i]]||"ãªã—"}`;
}
drawMy();
};
row.appendChild(d);
});
const revealBtn = document.getElementById("revealBtn");
const unrevealedCount = myRevealed.filter(v => !v).length;
if(selectedMy !== null && myNums[selectedMy] === 5 && unrevealedCount <= 2){
revealBtn.disabled = true;
} else {
revealBtn.disabled = false;
}
}

function drawEnemy(){
const row=document.getElementById("enemyRow");
row.innerHTML="";
enemyNums.forEach((n,i)=>{
const d=document.createElement("div");
d.className="num";
if(enemyRevealed[i]){
d.textContent=n;
d.classList.add("revealed");
} else {
d.textContent="?";
d.classList.add("hidden","clickable");
if(selectedEnemyPos===i) d.classList.add("selected");
d.onclick=()=>{
if(!openedThisTurn) return;
selectedEnemyPos=i;
document.getElementById("guessInfo").textContent=`ä½ç½®${i+1}ã‚’æŒ‡æ‘˜ä¸­`;
drawEnemy();
};
}
row.appendChild(d);
});
}

function drawNumberButtons(){
const area=document.getElementById("numberButtons");
area.innerHTML="";
for(let i=1;i<=9;i++){
const b=document.createElement("button");
b.className="numBtn";
b.textContent=i;
if(selectedGuessNum===i) b.classList.add("selected");
b.onclick=()=>{
selectedGuessNum=i;
drawNumberButtons();
};
area.appendChild(b);
}
}

document.getElementById("repeatConfirmBtn").onclick = () => {
if(!repeatPhase || selectedRepeatEffect === null) return;

// å†ç™ºå‹•ã™ã‚‹åŠ¹æœã ã‘ effectQueue ã«è¿½åŠ 
effectQueue.push({ owner: "player", num: selectedRepeatEffect });
guessLog.push(`åŠ¹æœ8ï¼šåŠ¹æœ${selectedRepeatEffect}ã‚’å†ç™ºå‹•`);

// ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†
repeatPhase = false;
repeatCandidates = [];
selectedRepeatEffect = null;
document.getElementById("repeatArea").style.display = "none";
document.getElementById("repeatConfirmBtn").style.display = "none";

// è‡ªåˆ†ã®å†ç™ºå‹•åŠ¹æœã ã‘è§£æ±º
resolveEffects();

// â˜…å†ç™ºå‹•ä¸­ã¯ AI ã®é–‹ç¤ºã¯ã—ãªã„

// æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºã«æˆ»ã™
startGuess();
drawMy(); drawEnemy(); drawLog();
};

function drawRepeatButtons(){
const area = document.getElementById("repeatArea");
area.innerHTML = "";
area.style.display = "block";

repeatCandidates.forEach(n=>{
const b = document.createElement("button");
b.className = "numBtn";
b.textContent = n;
if(selectedRepeatEffect === n) b.classList.add("selected");

b.onclick = ()=>{
selectedRepeatEffect = n;
drawRepeatButtons();
};

area.appendChild(b);
});
}

function drawLog(){
document.getElementById("guessLog").innerHTML=guessLog.join("<br>");
}

function finishRevealPhase(){
aiRevealTurn(); // AIãŒé–‹ç¤º
resolveEffects(); // â˜…ã“ã“ã§å¿…ãšåŠ¹æœè§£æ±º

// åŠ¹æœ5ãŒã‚ã‚Œã°ã“ã“ã§æ­¢ã¾ã‚‹
if(swapPhase || replacePhase) return;
if(!repeatPhase) startGuess();
}

// AIãŒé–‹ç¤ºã—ã¦ã‚‚å®‰å…¨ã‹åˆ¤å®š
function aiSafeToReveal(unrevealedIndices) {
// åŠ¹æœ9ä¸­ã¯é–“é•ãˆã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã®ã§é–‹ç¤ºã—ãªã„
if (aiEffect9Active) return false;

// çŸ¥ã£ã¦ã„ã‚‹æ•°å­—ã‚„æœ‰åŠ¹ãªæ•°å­—ãŒãªã„å ´åˆã¯é–‹ç¤ºã—ãªã„
const knownOrSafe = unrevealedIndices.filter(i => {
const n = enemyNums[i];
// åŠ¹æœ1ã¯ç›¸æ‰‹ã®åŠ¹æœã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã®ã§å®‰å…¨
// åŠ¹æœ8ã¯åˆå›å›é¿æ¸ˆã¿ã€9ã¯ãƒªã‚¹ã‚¯å¤§
return n !== 9;
});

return knownOrSafe.length > 0;
}
/* ---------- AIé–‹ç¤º ---------- */
function aiRevealTurn() {
const remainingUnrevealed = enemyRevealed.filter(v => !v).length;
if (remainingUnrevealed <= 1) return;

const unrevealedIndices = [];
enemyRevealed.forEach((v, i) => {
if (!v && !aiAlreadyRevealed.includes(i)) unrevealedIndices.push(i);
});
if (!unrevealedIndices.length) return;

// AIãŒé–‹ç¤ºã™ã¹ãæ•°å­—ã‚’å€™è£œã¨ã—ã¦æŠ½å‡º
let candidates = unrevealedIndices.filter(i => {
const n = enemyNums[i];

// åŠ¹æœ9ã¯ç¢ºå®Ÿã§ãªã‘ã‚Œã°é–‹ç¤ºã—ãªã„
if (n === 9 && !aiCertainCanUse9()) return false;

// 2,3ã¯åºç›¤ã®ã¿
if ((n === 2 || n === 3) && turn > 2) return false;

// 4,5,7ã¯ä¸åˆ©ãªå ´åˆã®ã¿
if ([4,5,7].includes(n) && !aiIsDisadvantaged()) return false;

// 6ã¯æƒ…å ±ãŒãã‚ã£ãŸä¸­ç›¤ä»¥é™
if (n === 6 && !aiCanBenefitFrom6()) return false;

// 8ã¯åˆå›é–‹ç¤ºã‚’é¿ã‘ã€å†ç™ºå‹•ç”¨ã«æ®‹ã™
if (n === 8 && aiRevealedEffects.length === 0) return false;

return true; // é–‹ç¤ºã—ã¦OK
});

if (!candidates.length) {
guessLog.push("AIã¯ã“ã®ã‚¿ãƒ¼ãƒ³é–‹ç¤ºã‚’è¦‹é€ã£ãŸ");
drawLog();
return;
}

// å€™è£œã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§1ã¤é¸ã¶
const idx = candidates[Math.floor(Math.random() * candidates.length)];
const num = enemyNums[idx];

enemyRevealed[idx] = true;
aiAlreadyRevealed.push(idx);
aiRevealedEffects.push(num);
guessLog.push(`AIãŒæ•°å­—${num}ã‚’é–‹ç¤ºï¼`);

// åŠ¹æœã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
effectQueue.push({ owner: "ai", num: num });

drawEnemy();
drawLog();
}
/* ---------- AIè£œåŠ©é–¢æ•° ---------- */
// AIãŒä¸åˆ©ã‹ã©ã†ã‹åˆ¤å®š
function aiIsDisadvantaged() {
const myRevealedCount = myRevealed.filter(v => v).length;
const aiRevealedCount = enemyRevealed.filter(v => v).length;
return aiRevealedCount < myRevealedCount;
}

// åŠ¹æœ6ãŒæœ‰åŠ¹ã‹
function aiCanBenefitFrom6() {
const remaining = myRevealed.filter(v => !v).length;
return remaining >= 2;
}

// åŠ¹æœ9ãŒå®‰å…¨ã‹
function aiCertainCanUse9() {
const unknowns = myNums.map((n,i)=>!myRevealed[i]?n:null).filter(n=>n!==null);
return unknowns.every(n => aiKnownNumbers.includes(n));
}
// ---------- AIæ¨ç† ----------
function aiGuessTurn() {
const revealedNumbers = myNums.filter((n, i) => myRevealed[i]);

// æœªé–‹ç¤ºãƒã‚¸ã‚·ãƒ§ãƒ³
const availablePositions = [];
for (let i = 0; i < 6; i++) {
if (!myRevealed[i] && !aiGuessedPositionsThisTurn.includes(i)) {
availablePositions.push(i);
}
}
if (!availablePositions.length) return;

// æŒ‡æ‘˜å¯èƒ½ãƒã‚¸ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§é¸æŠ
const pos = availablePositions[Math.floor(Math.random() * availablePositions.length)];

// å€™è£œæ•°å­—ã‚’ä½œæˆï¼ˆaiKnownNumbers ã‚’å„ªå…ˆï¼‰
let candidates = [];
for (let n = 1; n <= 9; n++) {
if (!aiExcludedNumbers.includes(n) && // é™¤å¤–æ¸ˆã¿ã§ã¯ãªã„
!aiTried[pos].includes(n) && // ãã®ä½ç½®ã§ã¾ã è©¦ã—ã¦ã„ãªã„
!revealedNumbers.includes(n)) { // ã™ã§ã«é–‹ç¤ºã•ã‚Œã¦ã„ãªã„
candidates.push(n);
}
}
if (!candidates.length) return;

// ã€ŒçŸ¥ã£ã¦ã„ã‚‹æ•°å­—ï¼ˆ2ã‚„3ã§å–å¾—æ¸ˆã¿ã‚‚å«ã‚€ï¼‰ã€ã‚’å„ªå…ˆ
const knownCandidates = candidates.filter(n => aiKnownNumbers.includes(n));
const guessNum = knownCandidates.length
? knownCandidates[Math.floor(Math.random() * knownCandidates.length)]
: candidates[Math.floor(Math.random() * candidates.length)];

// æŒ‡æ‘˜çµæœåˆ¤å®š
const success = myNums[pos] === guessNum;

// åŠ¹æœ9å¤±æ•—åˆ¤å®š
if (!success && effect9Active) {
guessLog.push("åŠ¹æœ9ï¼šæŒ‡æ‘˜ã«å¤±æ•—ã—ãŸãŸã‚æ•—åŒ—ï¼");
drawLog();
document.getElementById("loseScreen").style.display = "flex";
return;
}

// æŒ‡æ‘˜æˆåŠŸæ™‚ã®å‡¦ç†
if (success) {
myRevealed[pos] = true;
if (!aiKnownNumbers.includes(guessNum)) aiKnownNumbers.push(guessNum);
}

aiTried[pos].push(guessNum);
aiGuessedPositionsThisTurn.push(pos);
aiGuessCountThisTurn++;

guessLog.push(`AIï¼šä½ç½®${pos + 1} â†’ ${guessNum}ï¼ˆ${success ? "æˆåŠŸ" : "å¤±æ•—"}ï¼‰`);

drawMy();
drawLog();

// ã™ã¹ã¦å…¬é–‹ã•ã‚ŒãŸã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹åˆ©
if (myRevealed.every(v => v)) {
document.getElementById("loseScreen").style.display = "flex";
return;
}

// è¤‡æ•°å›æŒ‡æ‘˜å¯èƒ½ï¼ˆåŠ¹æœ6ãªã©ï¼‰
aiGuessRemaining--;
if (aiGuessRemaining > 0) {
aiGuessTurn();
}
}
/* ---------- æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ---------- */
function startGuess() {
if(replacePhase) return;
if(swapPhase) return;
if(repeatPhase) return;

openedThisTurn = true;

document.getElementById("revealBtn").style.display = "none";
document.getElementById("skipBtn").style.display = "none";

// ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š
if(skipPlayerGuessThisTurn){
guessLog.push("ã‚ãªãŸã®æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ");
drawLog();
if(!skipEnemyGuessThisTurn) aiGuessTurn();
endTurn();
return;
}

document.getElementById("guessArea").style.display = "block";
drawNumberButtons();
}
/* ---------- æ“ä½œ ---------- */
document.getElementById("revealBtn").onclick = () => {
if(openedThisTurn || selectedMy === null) return;

const unrevealedCount = myRevealed.filter(v => !v).length;
const num = myNums[selectedMy];

// åŠ¹æœ8ã®ç‰¹åˆ¥åˆ¤å®šï¼šã¾ã é–‹ç¤ºã—ãŸåŠ¹æœãŒãªã„å ´åˆã¯é–‹ç¤ºã§ããªã„
if(num === 8 && playerRevealedEffects.length === 0){
guessLog.push("åŠ¹æœ8ã¯ã¾ã ç™ºå‹•ã§ãã¾ã›ã‚“ï¼ˆé–‹ç¤ºæ¸ˆã¿åŠ¹æœãŒå¿…è¦ã§ã™ï¼‰");
drawLog();
return;
}
if(myNums[selectedMy] === 5 && unrevealedCount <= 2) return;

myRevealed[selectedMy] = true;
activeEffect = myNums[selectedMy];
playerRevealedEffects.push(activeEffect);
effectQueue.push({ owner: "player", num: activeEffect });

document.getElementById("revealBtn").style.display = "none";
document.getElementById("skipBtn").style.display = "none";

const isFirstReveal = !repeatPhase; // â˜…åˆå›é–‹ç¤ºã‹ã©ã†ã‹

// åŠ¹æœ8ã®å†ç™ºå‹•ãƒ•ã‚§ãƒ¼ã‚º
if(activeEffect === 8){
const candidates = playerRevealedEffects.filter(n => n !== 8);
if(candidates.length > 0){
repeatPhase = true;
repeatCandidates = candidates;
selectedRepeatEffect = null;
document.getElementById("repeatArea").style.display = "block";
document.getElementById("repeatConfirmBtn").style.display = "inline-block";
guessLog.push("åŠ¹æœ8ï¼šå†ç™ºå‹•ã™ã‚‹åŠ¹æœã‚’é¸æŠã—ã¦ãã ã•ã„");
drawRepeatButtons();
}
}

// â˜…AIé–‹ç¤ºã¯åˆå›é–‹ç¤ºã®ã¨ãã ã‘
if(isFirstReveal){
aiRevealTurn();
}

// è‡ªåˆ†ã®åŠ¹æœè§£æ±ºï¼ˆå†ç™ºå‹•ä¸­ã¯å†ç™ºå‹•ã®åŠ¹æœã ã‘å‡¦ç†ï¼‰
resolveEffects();

// repeatPhaseã§ãªã‘ã‚Œã°æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºã¸
if(!repeatPhase) startGuess();

drawMy(); drawEnemy(); drawLog();
};

document.getElementById("skipBtn").onclick=()=>{
if(openedThisTurn) return;
selectedMy=null; drawMy();
finishRevealPhase();
};

document.getElementById("guessBtn").onclick = () => {
if(selectedEnemyPos === null || selectedGuessNum === null) return;

const success = enemyNums[selectedEnemyPos] === selectedGuessNum;
if(!success && (effect9Active || aiEffect9Active)){
if(effect9Active){
guessLog.push("åŠ¹æœ9ï¼šæŒ‡æ‘˜ã«å¤±æ•—ã—ãŸãŸã‚æ•—åŒ—ï¼");
drawLog();
document.getElementById("loseScreen").style.display = "flex";
} else {
// AIã®åŠ¹æœ9ä¸­ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé–“é•ãˆãŸå ´åˆã¯å‹åˆ©
guessLog.push("AIã®åŠ¹æœ9ï¼šã‚ãªãŸã®æŒ‡æ‘˜ã«å¤±æ•—ã—ãŸãŸã‚å‹åˆ©ï¼");
drawLog();
document.getElementById("winScreen").style.display = "flex";
}
return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
}

// æŒ‡æ‘˜æˆåŠŸæ™‚ã®å‡¦ç†
if(success) enemyRevealed[selectedEnemyPos] = true;

guessLog.push(`T${turn}ï¼šä½ç½®${selectedEnemyPos+1} â†’ ${selectedGuessNum}ï¼ˆ${success ? "æˆåŠŸ" : "å¤±æ•—"}ï¼‰`);
drawEnemy(); drawLog();

if(enemyRevealed.every(v => v)){
document.getElementById("winScreen").style.display = "flex";
return;
}

playerGuessRemaining--;
if(playerGuessRemaining > 0){
selectedEnemyPos = null;
selectedGuessNum = null;
document.getElementById("guessInfo").textContent =
`ã‚‚ã†ä¸€åº¦æŒ‡æ‘˜ã§ãã¾ã™ï¼ˆæ®‹ã‚Š ${playerGuessRemaining} å›ï¼‰`;
drawEnemy();
drawNumberButtons();
return;
}

if(!skipEnemyGuessThisTurn){
aiGuessTurn();
} else {
guessLog.push("ç›¸æ‰‹ã®æŒ‡æ‘˜ãƒ•ã‚§ãƒ¼ã‚ºã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ");
drawLog();
}

endTurn();
};

// â˜… ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç† â˜…
function endTurn(){
turn++;
playerGuessRemaining = 1;
aiGuessRemaining = 1; 
aiGuessedPositionsThisTurn = [];
aiGuessCountThisTurn = 0;
selectedEnemyPos=null; selectedGuessNum=null; selectedMy=null;
openedThisTurn=false; activeEffect=null;
negatePlayerEffectThisTurn = false;
negateEnemyEffectThisTurn = false;
skipEnemyGuessThisTurn = false;
skipPlayerGuessThisTurn = false;
aiRevealedThisTurn = false;
selectedMy = null;
swapTargets = [];
document.getElementById("effectInfo").textContent = "é¸æŠä¸­ã®æ•°å­—ã®åŠ¹æœ: ãªã—";
document.getElementById("revealBtn").style.display="inline-block";
document.getElementById("skipBtn").style.display="inline-block";
document.getElementById("guessArea").style.display="none";
document.getElementById("revealBtn").disabled=false;
document.getElementById("skipBtn").disabled=false;
document.getElementById("guessInfo").textContent="ç›¸æ‰‹ã®ï¼Ÿã‚’ã‚¿ãƒƒãƒ—";

drawMy(); drawEnemy(); drawNumberButtons();
};

/* ---------- åˆå›æç”» ---------- */
drawMy(); drawEnemy(); drawNumberButtons(); drawLog();
</script>
</body>
</html>
